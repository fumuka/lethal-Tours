<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>リーサル計算ツール</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 420px;
      margin: 12px auto 24px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 12px #0001;
      padding: 18px 10px 24px 10px;
    }
    h2 {
      font-size: 1.3em;
      text-align: center;
      margin: 0 0 16px 0;
      letter-spacing: 1px;
    }
    .inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .input-group {
      flex: 1 1 48%;
      display: flex;
      flex-direction: column;
      font-size: 1em;
    }
    .input-group label {
      font-size: .98em;
      margin-bottom: 2px;
      color: #444;
    }
    .input-group input, .input-group select {
      font-size: 1.07em;
      padding: 5px 6px;
      border: 1px solid #bbb;
      border-radius: 5px;
      background: #fafbfc;
    }
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .row span {
      font-size: 1.13em;
      font-weight: bold;
    }
    .btns {
      display: flex;
      gap: 8px;
      margin: 14px 0 8px 0;
      justify-content: center;
    }
    button {
      flex: 1;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 9px 0;
      font-size: 1.06em;
      font-weight: bold;
      cursor: pointer;
      transition: background .15s;
    }
    button:active {
      background: #13539c;
    }
    .history-title {
      margin: 19px 0 3px 0;
      font-size: 1.07em;
      font-weight: normal;
      border-bottom: 1px solid #ddd;
      padding-bottom: 2px;
      color: #222;
    }
    .history-list {
      background: #f7f7fd;
      border-radius: 5px;
      padding: 8px 5px 8px 8px;
      font-size: .99em;
      line-height: 1.5;
      max-height: 220px;
      overflow-y: auto;
      margin-bottom: 0;
    }
    .end-msg {
      margin-top: 12px;
      color: #e53935;
      font-weight: bold;
      font-size: 1.14em;
      text-align: center;
    }
    @media (max-width: 450px) {
      .container { max-width: 97vw; padding: 9px 2vw 18px 2vw; }
      .inputs { gap: 6px; }
      button { font-size: 1em; padding: 8px 0; }
      .history-list { font-size: .98em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>リーサル計算ツール</h2>
    <div class="inputs">
      <div class="input-group">
        <label for="xPower">合計パワー X</label>
        <input id="xPower" type="number" min="1" step="1" value="240000">
      </div>
      <div class="input-group">
        <label for="leaderPower">相手リーダーのパワー L</label>
        <input id="leaderPower" type="number" min="1" step="1" value="20000">
      </div>
      <div class="input-group">
        <label for="yAttack">総攻撃回数 Y</label>
        <input id="yAttack" type="number" min="1" step="1" value="4">
      </div>
      <div class="input-group">
        <label for="zNeed">必要攻撃回数 Z</label>
        <select id="zNeed">
          <option value="2">2</option>
          <option value="3" selected>3</option>
        </select>
      </div>
    </div>
    <div class="row">
      <span>打点 A：</span>
      <span id="aDamage">-</span>
    </div>
    <div class="btns">
      <button id="calcBtn">計算</button>
      <button id="successBtn">攻撃が通った</button>
      <button id="failBtn">攻撃が守られた</button>
    </div>
    <div class="history-title">履歴</div>
    <div class="history-list" id="history"></div>
    <div class="end-msg" id="endMsg"></div>
  </div>
  <script>
    // 初期値
    let X = 240000, L = 20000, Y = 4, Z = 3;
    let attackLeft = Y, attackNeed = Z, totalPower = X, leaderPower = L;
    let originalY = Y, originalZ = Z, originalX = X, originalL = L;
    let history = [];
    let ended = false;

    const $ = id => document.getElementById(id);
    // 5000単位(2500捨2501入)
    const to5000Unit = v => Math.floor((v + 2499) / 5000) * 5000;

    const updateVars = () => {
      X = parseInt($("xPower").value, 10) || 0;
      L = parseInt($("leaderPower").value, 10) || 0;
      Y = parseInt($("yAttack").value, 10) || 0;
      Z = parseInt($("zNeed").value, 10) || 0;
    };

    function showA(value) {
      $("aDamage").textContent = value > 0 ? value : "-";
    }

    function formatHistory() {
      if (!history.length) return "（まだ履歴はありません）";
      return history.map((h, i) =>
        `#${i+1} 攻撃: 打点A=${h.A} | 残りパワーX=${h.X} | 残り攻撃Y=${h.Y} | 残り必要Z=${h.Z} (${h.pass ? "通った" : h.pass===false ? "守られた" : h.note})`
      ).join("<br>");
    }

    function endCheck() {
      if (attackLeft <= 0) {
        $("endMsg").textContent = "攻撃回数終了！";
        ended = true;
        return true;
      }
      if (totalPower <= 0) {
        $("endMsg").textContent = "パワーが残っていません。";
        ended = true;
        return true;
      }
      if (attackNeed <= 0) {
        $("endMsg").textContent = "必要攻撃回数を達成！";
        ended = true;
        return true;
      }
      return false;
    }

    // 均等割り（5000単位）でZ=Yの時の分割
    // ※5000単位で均等割り切れない場合は、最初の攻撃を低くする(例)X=15000の場合、5000・10000
    function splitPowerForZ(X, Z) {
      if (Z === 1) return [X];
      let values = [];
      let base = Math.floor(X / Z / 5000) * 5000;
      let totalBase = base * Z;
      let remain = X - totalBase;

      // まず全てbaseで埋める
      for (let i = 0; i < Z; i++) values.push(base);

      // 残りを5000単位ずつ後ろから割り当て
      for (let i = Z - 1; i >= 0 && remain > 0; i--) {
        let add = Math.min(remain, 5000);
        values[i] += add;
        remain -= add;
      }

      // もし割り切れない場合、最初の攻撃を低く
      if (X % 5000 !== 0 && Z >= 2) {
        let sum = values.reduce((a, b) => a + b, 0);
        let over = sum - X;
        if (over > 0) values[0] -= over;
      }
      return values;
    }

    // メイン打点計算
    function calcA(X, L, Y, Z, origY, origZ) {
      if (Z === Y && Z > 0) { // 均等割り
        const arr = splitPowerForZ(X, Z);
        return arr[0];
      }
      if (Z === 2 && Y > 2) {
        // A=(x-(L-5000)×((y-2)(y-1))/2)/y+(L-5000)×(Y-2)
        let l5 = L - 5000;
        let A = (X - l5 * ((Y - 2) * (Y - 1) / 2)) / Y + l5 * (Y - 2);
        return to5000Unit(A);
      }
      if (Z === 3 && Y > 3) {
        // A=x/y+((L-5000)/3)/y×((y^2-y)/2-3)
        let l5 = (L - 5000) / 3;
        let A = (X / Y) + (l5 / Y) * ((Y * Y - Y) / 2 - 3);
        return to5000Unit(A);
      }
      // 基本均等割り
      return to5000Unit(X / Z);
    }

    // 入力値変更時の再計算
    function recalc(resetHistory = true) {
      updateVars();
      totalPower = X;
      leaderPower = L;
      attackLeft = Y;
      attackNeed = Z;
      originalY = Y;
      originalZ = Z;
      originalX = X;
      originalL = L;
      ended = false;
      $("endMsg").textContent = "";
      if (resetHistory) history = [];
      let A = calcA(totalPower, leaderPower, attackLeft, attackNeed, originalY, originalZ);
      showA(A);
      $("history").innerHTML = formatHistory();
    }

    // 攻撃後の履歴と計算
    function afterAttack(pass) {
      if (ended) return;
      let A = calcA(totalPower, leaderPower, attackLeft, attackNeed, originalY, originalZ);

      // Z=Y時の均等割り
      if (attackNeed === attackLeft && attackLeft > 0) {
        let arr = splitPowerForZ(totalPower, attackNeed);
        for (let i = 0; i < attackNeed; i++) {
          history.push({A: arr[i], X: totalPower - arr.slice(0, i + 1).reduce((a, b) => a + b, 0), Y: attackLeft - i - 1, Z: attackNeed - i - 1, pass: pass, note: "均等割り"});
        }
        attackLeft = 0;
        totalPower = 0;
        attackNeed = 0;
        showA("-");
        $("history").innerHTML = formatHistory();
        endCheck();
        return;
      }

      if (pass) {
        history.push({A, X: totalPower - A, Y: attackLeft - 1, Z: attackNeed - 1, pass: true});
        totalPower -= A;
        attackLeft -= 1;
        attackNeed -= 1;
        if (attackNeed > 0 && attackLeft > 0) {
          let nextA = calcA(totalPower, leaderPower, attackLeft, attackNeed, originalY, originalZ);
          showA(nextA);
        } else {
          showA("-");
        }
      } else {
        history.push({A, X: totalPower - A, Y: attackLeft - 1, Z: attackNeed, pass: false});
        totalPower -= A;
        attackLeft -= 1;
        if (attackNeed === 2 && attackLeft > 1) {
          let nextA = calcA(totalPower, leaderPower, attackLeft, attackNeed, originalY, originalZ);
          showA(nextA);
        } else if (attackNeed === 3 && attackLeft > 2) {
          let nextA = calcA(totalPower, leaderPower, attackLeft, attackNeed, originalY, originalZ);
          showA(nextA);
        } else {
          showA("-");
        }
      }
      $("history").innerHTML = formatHistory();
      endCheck();
    }

    $("calcBtn").onclick = () => {
      recalc(true);
    };
    $("successBtn").onclick = () => afterAttack(true);
    $("failBtn").onclick = () => afterAttack(false);
    $("xPower").onchange = $("leaderPower").onchange = $("yAttack").onchange = $("zNeed").onchange = () => recalc(true);

    // 初期表示
    recalc(true);
  </script>
</body>
</html>